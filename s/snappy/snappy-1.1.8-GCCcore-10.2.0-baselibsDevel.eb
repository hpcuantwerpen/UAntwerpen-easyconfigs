easyblock = 'CMakeMake'

local_buildset =         '2020b'
local_gcc_version =      '10.2.0'
local_binutils_version = '2.35'

local_LZO_version =              '2.10'          # http://www.oberhumer.com/opensource/lzo/#download
local_snappy_version =           '1.1.8'         # https://github.com/google/snappy/releases
local_zlib_version =             '1.2.11'        # https://zlib.net/

name =          'snappy'
version =       local_snappy_version
versionsuffix = '-baselibsDevel'

homepage = 'https://github.com/google/snappy'

whatis = [
    'Description: Snappy is a compression/decompression library aiming for very high speeds and reasonable compression'
]

description = """
Snappy is a compression/decompression library. It does not aim
for maximum compression, or compatibility with any other compression library;
instead, it aims for very high speeds and reasonable compression.
"""

toolchain = {'name': 'GCCcore', 'version': local_gcc_version}
toolchainopts = {'pic': True} # Doesn't make sense here but needed to imitate the behaviour of the baselibs build.

sources = [{
    'download_filename': '%(version)s.tar.gz',
    'filename':          SOURCE_TAR_GZ,
    'source_urls':       ['https://github.com/google/snappy/archive/']
}]
checksums = ['16b677f07832a612b0836178db7f374e414f94657c138e6993cbfc5dcc58651f']

builddependencies = [
    ('binutils',   local_binutils_version),
    ('buildtools', local_buildset,         '', True), # For CMake
]

dependencies = [
    ('zlib', local_zlib_version, versionsuffix),
    ('LZO',  local_LZO_version,  versionsuffix),
]

# In the Bundle, as of EasyBuild 4.2, it is better to set this to False,
# though it does give a cleaner build procedure when this is set to True...
separate_build_dir = False

import os as local_os
local_UAarch = local_os.environ['VSC_ARCH_LOCAL']
if local_UAarch == "ivybridge":
    local_snappy_opts = ' -DSNAPPY_REQUIRE_AVX=ON '
else:
    local_snappy_opts = ' -DSNAPPY_REQUIRE_AVX2=ON '
local_setbuilddir = '-DCMAKE_INSTALL_LIBDIR="%(installdir)s/lib" '
   
configopts = [
    '-DBUILD_SHARED_LIBS=OFF' + local_snappy_opts + local_setbuilddir, 
    '-DBUILD_SHARED_LIBS=ON'  + local_snappy_opts + local_setbuilddir
]

buildopts = 'VERBOSE=1'

sanity_check_paths = {
    'files': ['lib/libsnappy.a', 'lib/libsnappy.%s' % SHLIB_EXT, 'include/snappy.h'],
    'dirs':  ['']
}

moduleclass = 'lib'
